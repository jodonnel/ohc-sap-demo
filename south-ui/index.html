<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Confront the Wumpus ‚Äî OHC Edge Demo</title>
<link href="https://fonts.googleapis.com/css2?family=Red+Hat+Display:wght@300;400;700;900&family=Red+Hat+Mono:wght@400;700&family=Red+Hat+Text:wght@300;400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #06090F; --surface: #111827; --border: #253040;
    --muted: #8B949E; --text: #F0F4F8;
    --dim: #6E7B8B;
    --green: #00D26A; --blue: #0070F2; --red: #EE0000;
    --amber: #F59E0B; --purple: #A855F7; --orange: #F97316;
    --teal: #14B8A6;
  }
  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  body {
    background: var(--bg); color: var(--text);
    font-family: 'Red Hat Display', -apple-system, sans-serif;
    min-height: 100dvh; overflow-x: hidden;
    display: flex; flex-direction: column;
  }

  /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
  .header {
    padding: 12px 16px; display: flex; justify-content: space-between; align-items: center;
    border-bottom: 1px solid var(--border);
  }
  .header .logo { font-size: 11px; font-weight: 700; letter-spacing: 1px; }
  .header .logo .rh { color: var(--red); }
  .header .logo .sep { color: var(--muted); margin: 0 6px; }
  .header .logo .sap { color: var(--blue); }
  .header .status { display: flex; align-items: center; gap: 6px; }
  .header .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--green); animation: pulse 2s infinite; }
  .header .evtcount { font-size: 11px; color: var(--green); font-variant-numeric: tabular-nums; }

  /* ‚îÄ‚îÄ Game area ‚îÄ‚îÄ */
  .game { flex: 1; display: flex; flex-direction: column; padding: 16px; gap: 12px; }

  .room-display {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; display: flex; flex-direction: column;
    align-items: center; justify-content: center; padding: 16px 24px;
    position: relative; overflow: hidden;
  }
  .room-display::before {
    content: ''; position: absolute; inset: 0;
    background: radial-gradient(circle at 50% 40%, rgba(0,210,106,0.04) 0%, transparent 70%);
    pointer-events: none;
  }

  .room-icon { font-size: 48px; margin-bottom: 6px; transition: transform 0.2s; }
  .room-name { font-size: 20px; font-weight: 700; margin-bottom: 2px; color: #FFFFFF; }
  .room-desc { font-size: 13px; color: #9CA3AF; text-align: center; max-width: 280px; line-height: 1.4; }
  .room-alert {
    margin-top: 12px; font-size: 12px; font-weight: 600; padding: 6px 14px;
    border-radius: 20px; animation: fadeIn 0.3s;
  }
  .room-alert.warn { background: rgba(249,115,22,0.2); color: #FB923C; border: 1px solid rgba(249,115,22,0.4); }
  .room-alert.danger { background: rgba(238,0,0,0.2); color: #FF4444; border: 1px solid rgba(238,0,0,0.4); }
  .room-alert.safe { background: rgba(0,210,106,0.15); color: #34D399; border: 1px solid rgba(0,210,106,0.4); }
  .room-alert.info { background: rgba(0,112,242,0.15); color: #60A5FA; border: 1px solid rgba(0,112,242,0.4); }

  /* ‚îÄ‚îÄ Minimap ‚îÄ‚îÄ */
  .minimap {
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px;
    padding: 8px; background: var(--surface); border: 1px solid var(--border);
    border-radius: 12px;
  }
  .map-cell {
    aspect-ratio: 1; border-radius: 6px; background: var(--border);
    display: flex; align-items: center; justify-content: center;
    font-size: 32px; opacity: 0.6; transition: all 0.2s;
  }
  .map-cell.visited { opacity: 0.85; background: rgba(0,210,106,0.12); border: 1px solid rgba(0,210,106,0.3); }
  .map-cell.current { opacity: 1; background: rgba(0,210,106,0.25); border: 2px solid var(--green); box-shadow: 0 0 14px rgba(0,210,106,0.3); }
  .map-cell.wumpus-found { opacity: 1; background: rgba(238,0,0,0.2); border: 1px solid var(--red); }

  /* ‚îÄ‚îÄ Actions ‚îÄ‚îÄ */
  .actions {
    display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
  }
  .action-btn {
    background: var(--surface); border: 1px solid #2D3748;
    border-radius: 12px; padding: 14px; color: #FFFFFF;
    font-size: 15px; font-weight: 600; cursor: pointer;
    display: flex; align-items: center; gap: 8px; justify-content: center;
    transition: all 0.15s; -webkit-user-select: none; user-select: none;
  }
  .action-btn:active { transform: scale(0.96); background: rgba(0,210,106,0.1); border-color: var(--green); }
  .action-btn .icon { font-size: 24px; }
  .action-btn.disabled { opacity: 0.35; pointer-events: none; }
  .action-btn.task-btn { border-color: var(--amber); }
  .action-btn.task-btn:active { border-color: var(--green); background: rgba(0,210,106,0.08); }

  .task-bar {
    display: flex; gap: 6px; align-items: center; padding: 8px 12px;
    background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
  }
  .task-pip {
    width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--border);
    display: flex; align-items: center; justify-content: center; font-size: 11px;
    transition: all 0.3s;
  }
  .task-pip.done { border-color: var(--green); background: rgba(0,210,106,0.15); color: var(--green); }
  .task-label { font-size: 12px; color: #9CA3AF; margin-left: auto; }
  .task-label strong { color: var(--green); }

  .map-cell.has-task { border: 2px solid var(--amber); opacity: 0.7; }
  .map-cell.task-done { border: 2px solid var(--green); }
  .map-cell.locked-out { opacity: 0.4; background: rgba(238,0,0,0.15); border: 1px solid rgba(238,0,0,0.4); }

  .room-alert.locked { background: rgba(238,0,0,0.1); color: var(--red); border: 1px solid rgba(238,0,0,0.25); }

  @keyframes shake { 0%,100% { transform:translateX(0); } 25% { transform:translateX(-6px); } 75% { transform:translateX(6px); } }

  /* ‚îÄ‚îÄ Event ticker ‚îÄ‚îÄ */
  .ticker-toggle {
    display: flex; justify-content: center; padding: 4px;
  }
  .ticker-btn {
    background: none; border: none; color: var(--muted); font-size: 10px;
    cursor: pointer; padding: 4px 12px; letter-spacing: 1px; text-transform: uppercase;
  }
  .ticker-btn:hover { color: var(--text); }

  .ticker {
    max-height: 0; overflow: hidden; transition: max-height 0.3s;
    background: var(--surface); border-top: 1px solid var(--border);
  }
  .ticker.open { max-height: 200px; }
  .ticker-inner {
    padding: 8px 12px; max-height: 180px; overflow-y: auto;
    font-family: 'Courier New', monospace; font-size: 10px; color: var(--muted);
    line-height: 1.6;
  }
  .ticker-inner .evt { animation: fadeIn 0.2s; }
  .ticker-inner .evt .ts { color: var(--muted); }
  .ticker-inner .evt .type { font-weight: 700; }
  .ticker-inner .evt .type.tap { color: var(--green); }
  .ticker-inner .evt .type.status { color: var(--blue); }
  .ticker-inner .evt .type.alert { color: var(--orange); }
  .ticker-inner .evt .type.telem { color: var(--purple); }
  .ticker-inner .evt .type.sensor { color: var(--teal); }
  .ticker-inner .evt .src { color: var(--text); opacity: 0.6; }

  /* ‚îÄ‚îÄ End screen ‚îÄ‚îÄ */
  .end-screen {
    flex: 1; display: none; flex-direction: column; align-items: center;
    justify-content: center; padding: 32px; text-align: center; gap: 16px;
  }
  .end-screen.active { display: flex; }
  .end-icon { font-size: 80px; }
  .end-title { font-size: 28px; font-weight: 700; }
  .end-stats { font-size: 14px; color: var(--muted); line-height: 1.8; }
  .end-stats strong { color: var(--green); }

  @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.4; } }
  @keyframes fadeIn { from { opacity:0; transform:translateY(4px); } to { opacity:1; transform:translateY(0); } }

  /* Splash */
  .splash {
    position: fixed; inset: 0; background: var(--bg); z-index: 100;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    gap: 20px; padding: 32px;
  }
  .splash.gone { display: none; }
  .splash h1 { font-size: 28px; font-weight: 700; text-align: center; }
  .splash p { font-size: 14px; color: #9CA3AF; text-align: center; max-width: 300px; line-height: 1.5; }
  .splash .start-btn {
    background: var(--red); color: #000000; border: none; border-radius: 12px;
    padding: 14px 40px; font-size: 16px; font-weight: 700; cursor: pointer;
    margin-top: 12px; transition: transform 0.15s;
  }
  .splash .start-btn:active { transform: scale(0.96); }
</style>
</head>
<body>

<!-- Splash / entry -->
<div class="splash" id="splash">
  <div style="font-size:64px">üè¢</div>
  <h1>Confront the Wumpus</h1>
  <p>Badge through 12 zones. Complete tasks. Find the threat. Every action is a real Lenel OnGuard event flowing through SAP Edge Integration Cell on Red Hat OpenShift.</p>
  <button class="start-btn" id="startBtn">Activate Badge</button>
  <p style="font-size:11px; margin-top:8px">~90 seconds ¬∑ Complete 3 tasks to prepare, then confront the wumpus</p>
</div>

<!-- Main game -->
<div class="header">
  <div class="logo"><span class="rh">RED HAT</span><span class="sep">√ó</span><span class="sap">SAP</span></div>
  <div class="status"><div class="dot" id="dot"></div><span class="evtcount" id="evtCount">0 events</span></div>
</div>

<div class="game" id="gameArea">
  <div class="task-bar" id="taskBar">
    <div class="task-pip" id="pip0"></div>
    <div class="task-pip" id="pip1"></div>
    <div class="task-pip" id="pip2"></div>
    <span class="task-label"><strong id="tasksDone">0</strong>/3 tasks ‚Äî <span id="taskHint">complete tasks to confront the wumpus</span></span>
  </div>

  <div class="room-display" id="roomDisplay">
    <div class="room-icon" id="roomIcon">üè¢</div>
    <div class="room-name" id="roomName">Lobby</div>
    <div class="room-desc" id="roomDesc">Main entrance. Security desk ahead.</div>
    <div class="room-alert" id="roomAlert" style="display:none"></div>
  </div>

  <div class="minimap" id="minimap"></div>

  <div class="actions" id="actions"></div>
</div>

<div class="end-screen" id="endScreen">
  <div class="end-icon" id="endIcon">üèÜ</div>
  <div class="end-title" id="endTitle">Building Secured</div>
  <div class="end-stats" id="endStats"></div>
</div>

<div class="ticker-toggle">
  <button class="ticker-btn" id="tickerBtn">‚ñ≤ Event stream</button>
</div>
<div class="ticker" id="ticker">
  <div class="ticker-inner" id="tickerInner"></div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SOUTH-SIDE WUMPUS ‚Äî "Secure the Building"
//
// 12 rooms in a 4√ó3 grid. Wumpus (threat) hides in one.
// Player navigates, gets hints, makes choices.
// ~40 events over ~90 seconds.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ Config ‚îÄ‚îÄ
const INGEST_URL = "/ingest"; // north-side endpoint
const ROOMS = [
  { id: 0,  icon: "üè¢", name: "Lobby",         desc: "Main entrance. Visitor kiosk and security desk.", adj: [1, 4] },
  { id: 1,  icon: "üõó", name: "Elevator Bay",   desc: "Three elevators. Floor indicator stuck on 3.", adj: [0, 2, 5],
    task: { icon: "üìã", label: "Check elevator log",
      prompt: "Maintenance log shows elevator 2 serviced 47 days ago ‚Äî overdue. Flag it?",
      choices: ["üö© Flag overdue", "‚úÖ Looks fine"],
      evType: "maintenance.elevator_check", evSrc: "elevator-ctrl-bay-1",
      evData: { system: "OTIS-SeriesR", unit: "ELEV-02", lastService: "2025-12-30", intervalDays: 30, status: "OVERDUE" }}},
  { id: 2,  icon: "‚òï", name: "Break Room",      desc: "Coffee machine humming. Badge reader on the inner door.", adj: [1, 3, 6],
    task: { icon: "üî•", label: "Check fire extinguisher",
      prompt: "Extinguisher gauge reads yellow zone. Pressure may be low.",
      choices: ["üî¥ Report to safety", "üü¢ Gauge is fine"],
      evType: "safety.fire_equipment", evSrc: "safety-inspector-breakroom",
      evData: { equipment: "FE-BR-001", type: "ABC dry chemical", gauge: "yellow", lastInspection: "2025-08-15", status: "NEEDS_SERVICE" }}},
  { id: 3,  icon: "üì¶", name: "Loading Dock",    desc: "External access. Camera feeds look grainy.", adj: [2, 7],
    task: { icon: "üìπ", label: "Review camera feed",
      prompt: "Camera 7 feed degraded ‚Äî 40% packet loss. Tampering or hardware failure?",
      choices: ["üö® Escalate to SOC", "üîß Reset camera"],
      evType: "surveillance.camera_diag", evSrc: "vms-camera-dock-7",
      evData: { cameraID: "CAM-DOCK-07", model: "Axis P3245-V", packetLoss: "40%", firmware: "10.12.114", status: "DEGRADED" }}},
  { id: 4,  icon: "üñ•Ô∏è", name: "NOC",            desc: "Network Operations Center. Wall of screens.", adj: [0, 5, 8],
    task: { icon: "üå°Ô∏è", label: "Check HVAC alerts",
      prompt: "Zone 4 reading 81¬∞F ‚Äî above 78¬∞F threshold. Server inlet temps rising.",
      choices: ["‚ùÑÔ∏è Force cooling override", "‚è≥ Wait and monitor"],
      evType: "building.hvac_override", evSrc: "bms-hvac-zone-4",
      evData: { zone: 4, currentTemp: 81.2, threshold: 78.0, setpoint: 72.0, mode: "COOLING", status: "THRESHOLD_EXCEEDED" }}},
  { id: 5,  icon: "üèõÔ∏è", name: "Main Corridor",  desc: "Long hallway. Motion sensors every 20 feet.", adj: [1, 4, 6, 9] },
  { id: 6,  icon: "üî¨", name: "Lab",             desc: "R&D floor. Biometric access required.", adj: [2, 5, 7, 10],
    task: { icon: "üß¨", label: "Biometric enrollment",
      prompt: "Lab requires fingerprint verification. Enroll to proceed.",
      choices: ["üëÜ Scan fingerprint", "‚è≠Ô∏è Skip ‚Äî badge only"],
      evType: "access.biometric_enroll", evSrc: "lenel-biometric-lab",
      evData: { readerType: "HID iCLASS SE RB25F", method: "fingerprint", template: "ISO-19795-1", quality: 92, accessLevel: "LAB-SECURE" }}},
  { id: 7,  icon: "üö™", name: "Server Room",     desc: "Cold air. Racks blinking. Man-trap entrance.", adj: [3, 6, 11],
    task: { icon: "üå°Ô∏è", label: "Log rack temperature",
      prompt: "Rack B3 inlet: 74¬∞F, outlet: 96¬∞F. Delta 22¬∞F ‚Äî within spec but high.",
      choices: ["üìù Log and flag", "‚úÖ Within spec"],
      evType: "telemetry.rack_temp", evSrc: "dcim-sensor-rack-B3",
      evData: { rack: "B3", inlet: 74.1, outlet: 96.3, delta: 22.2, threshold: 25.0, pduLoad: "4.2kW", status: "NOMINAL_HIGH" }}},
  { id: 8,  icon: "üì°", name: "Comms Closet",    desc: "MDF. Fiber trunks. UPS battery indicator amber.", adj: [4, 9],
    task: { icon: "üîã", label: "Check UPS battery",
      prompt: "UPS: 34 min runtime, battery health 71%. Replace threshold 60%.",
      choices: ["üìã Schedule replacement", "‚úÖ Above threshold"],
      evType: "telemetry.ups_diag", evSrc: "ups-apc-mdf-01",
      evData: { model: "APC Smart-UPS 3000", runtime_min: 34, batteryHealth: 71, replaceThreshold: 60, loadPct: 62 }}},
  { id: 9,  icon: "ü™ü", name: "Executive Suite", desc: "Corner office. Glass walls. Privacy film active.", adj: [5, 8, 10],
    task: { icon: "ü™ü", label: "Toggle privacy film",
      prompt: "Privacy film engaged. Override to inspect the room?",
      choices: ["üëÅÔ∏è Disengage film", "üîí Leave it on"],
      evType: "building.privacy_film", evSrc: "bms-smartglass-exec",
      evData: { zone: "EXEC-SUITE-A", filmState: "OPAQUE", overrideBy: "security-sweep", powerDraw: "12W" }}},
  { id: 10, icon: "üè•", name: "Wellness Room",   desc: "Quiet zone. Air quality sensor blinking.", adj: [6, 9, 11],
    task: { icon: "üí®", label: "Read air quality",
      prompt: "CO2: 1,150 ppm (threshold 1,000). VOCs elevated. Needs ventilation?",
      choices: ["üå¨Ô∏è Trigger vent flush", "üìä Log reading only"],
      evType: "telemetry.air_quality", evSrc: "aq-sensor-wellness-01",
      evData: { co2_ppm: 1150, voc_ppb: 380, pm25: 8.2, humidity: 58, temp_f: 73.4, status: "ELEVATED" }}},
  { id: 11, icon: "üîí", name: "Vault",           desc: "High-security storage. Multi-factor required.", adj: [7, 10] },
];

// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let currentRoom = 0;
let visited = new Set([0]);
let eventCount = 0;
let wumpusRoom = -1;
let gameOver = false;
let startTime = 0;
let deviceProfile = {};
let tickerOpen = false;
let hintRooms = new Set(); // rooms adjacent to wumpus
let tasksCompleted = [];
let completedRoomTasks = new Set();
let lockedRooms = new Set();
const TASKS_REQUIRED = 3;

// Simulated Lenel OnGuard badge credential
const badge = {
  cardholderID: 100000 + Math.floor(Math.random() * 99999),
  badgeID: 200000 + Math.floor(Math.random() * 50000),
  facilityCode: 1042,
  cardFormat: "HID H10301 26-bit",
  firstName: "Attendee",
  lastName: "#" + String(Math.floor(Math.random() * 9999)).padStart(4, "0"),
  accessLevel: "CONF-GENERAL",
  department: "Event Guest",
  issueDate: new Date().toISOString().slice(0, 10),
  expiryDate: new Date(Date.now() + 86400000).toISOString().slice(0, 10),
};

// ‚îÄ‚îÄ DOM ‚îÄ‚îÄ
const splash = document.getElementById("splash");
const startBtn = document.getElementById("startBtn");
const roomIcon = document.getElementById("roomIcon");
const roomName = document.getElementById("roomName");
const roomDesc = document.getElementById("roomDesc");
const roomAlert = document.getElementById("roomAlert");
const roomDisplay = document.getElementById("roomDisplay");
const minimapEl = document.getElementById("minimap");
const actionsEl = document.getElementById("actions");
const evtCountEl = document.getElementById("evtCount");
const endScreen = document.getElementById("endScreen");
const endIcon = document.getElementById("endIcon");
const endTitle = document.getElementById("endTitle");
const endStats = document.getElementById("endStats");
const gameArea = document.getElementById("gameArea");
const tickerEl = document.getElementById("ticker");
const tickerInner = document.getElementById("tickerInner");
const tickerBtn = document.getElementById("tickerBtn");
const tasksDoneEl = document.getElementById("tasksDone");
const taskHintEl = document.getElementById("taskHint");
const dotEl = document.getElementById("dot");

// ‚îÄ‚îÄ Ticker toggle ‚îÄ‚îÄ
tickerBtn.onclick = () => {
  tickerOpen = !tickerOpen;
  tickerEl.classList.toggle("open", tickerOpen);
  tickerBtn.innerText = tickerOpen ? "‚ñº Event stream" : "‚ñ≤ Event stream";
};

// ‚îÄ‚îÄ Event sending ‚îÄ‚îÄ
function sendEvent(type, cls, source, data) {
  eventCount++;
  evtCountEl.innerText = eventCount + " events";

  const evt = {
    specversion: "1.0",
    type: "ohc.demo." + type,
    source: "south/" + source,
    id: crypto.randomUUID ? crypto.randomUUID() : "evt-" + eventCount,
    time: new Date().toISOString(),
    data: {
      ...data,
      room: ROOMS[currentRoom].name,
      seq: eventCount,
    }
  };

  // Send to north
  fetch(INGEST_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(evt),
  }).catch(() => {});

  // Ticker
  const div = document.createElement("div");
  div.className = "evt";
  const tsStr = new Date().toLocaleTimeString();
  div.innerHTML = '<span class="ts">' + tsStr + '</span> <span class="type ' + cls + '">' + type.toUpperCase() + '</span> <span class="src">' + source + ' ‚Üí ' + (data.action || data.metric || data.result || "") + '</span>';
  tickerInner.prepend(div);
  if (tickerInner.children.length > 50) tickerInner.lastChild.remove();
}

// ‚îÄ‚îÄ Device telemetry (passive, no prompts) ‚îÄ‚îÄ
async function captureDeviceTelemetry() {
  // Locale
  const locale = navigator.language || "unknown";
  sendEvent("telemetry.locale", "telem", "device-profile", {
    metric: "locale",
    value: locale,
    languages: navigator.languages ? navigator.languages.join(",") : locale,
  });

  // Screen + device
  sendEvent("telemetry.device", "telem", "device-profile", {
    metric: "device",
    screenW: screen.width,
    screenH: screen.height,
    viewportW: window.innerWidth,
    viewportH: window.innerHeight,
    dpr: window.devicePixelRatio,
    cores: navigator.hardwareConcurrency || "unknown",
    darkMode: window.matchMedia("(prefers-color-scheme:dark)").matches,
    touch: "ontouchstart" in window,
  });

  // Network
  if (navigator.connection) {
    const c = navigator.connection;
    sendEvent("telemetry.network", "telem", "device-profile", {
      metric: "network",
      type: c.effectiveType || "unknown",
      downlink: c.downlink || "unknown",
      rtt: c.rtt || "unknown",
      saveData: c.saveData || false,
    });
  }

  // Battery
  if (navigator.getBattery) {
    try {
      const b = await navigator.getBattery();
      sendEvent("telemetry.battery", "telem", "device-profile", {
        metric: "battery",
        level: Math.round(b.level * 100) + "%",
        charging: b.charging,
      });
    } catch (e) {}
  }
}

// ‚îÄ‚îÄ Task system ‚îÄ‚îÄ
function updateTaskBar() {
  for (let i = 0; i < 3; i++) {
    const pip = document.getElementById("pip" + i);
    if (i < tasksCompleted.length) {
      pip.classList.add("done");
      pip.innerText = "‚úì";
    } else {
      pip.classList.remove("done");
      pip.innerText = "";
    }
  }
  tasksDoneEl.innerText = tasksCompleted.length;
  if (tasksCompleted.length >= TASKS_REQUIRED) {
    taskHintEl.innerText = "READY ‚Äî confront the wumpus!";
    taskHintEl.style.color = "var(--green)";
    // Unlock all previously denied rooms
    lockedRooms.clear();
    renderMinimap();
  }
}

function startTask(room) {
  const task = room.task;
  actionsEl.innerHTML = "";
  roomAlert.style.display = "";
  roomAlert.className = "room-alert info";
  roomAlert.innerText = task.prompt;
  task.choices.forEach((choice, idx) => {
    const btn = document.createElement("button");
    btn.className = "action-btn task-btn";
    btn.innerHTML = choice;
    btn.onclick = () => completeTask(room, task, idx);
    actionsEl.appendChild(btn);
  });
}

function completeTask(room, task, choiceIdx) {
  completedRoomTasks.add(currentRoom);
  tasksCompleted.push({ room: room.name, task: task.evType, choice: choiceIdx });
  sendEvent(task.evType, "status", task.evSrc, {
    ...task.evData,
    action: task.evType,
    choiceIndex: choiceIdx,
    choiceLabel: task.choices[choiceIdx],
    badgeID: badge.badgeID,
    cardholderID: badge.cardholderID,
  });
  roomAlert.style.display = "";
  roomAlert.className = "room-alert safe";
  roomAlert.innerText = "‚úÖ Task complete ‚Äî logged and escalated";
  updateTaskBar();
  setTimeout(() => renderActions(room), 1000);
}

// ‚îÄ‚îÄ Place wumpus ‚îÄ‚îÄ
function placeWumpus() {
  // Not in room 0 (lobby) and not adjacent to 0
  const candidates = ROOMS.filter(r => r.id !== 0 && !ROOMS[0].adj.includes(r.id));
  wumpusRoom = candidates[Math.floor(Math.random() * candidates.length)].id;
  hintRooms = new Set(ROOMS[wumpusRoom].adj);
}

// ‚îÄ‚îÄ Minimap ‚îÄ‚îÄ
function renderMinimap() {
  minimapEl.innerHTML = "";
  ROOMS.forEach((r, i) => {
    const cell = document.createElement("div");
    cell.className = "map-cell";
    if (i === currentRoom) cell.classList.add("current");
    else if (visited.has(i)) cell.classList.add("visited");
    if (r.task && !completedRoomTasks.has(i) && visited.has(i)) cell.classList.add("has-task");
    if (completedRoomTasks.has(i)) cell.classList.add("task-done");
    if (gameOver && i === wumpusRoom) cell.classList.add("wumpus-found");
    if (lockedRooms.has(i)) cell.classList.add("locked-out");
    cell.innerText = visited.has(i) || (gameOver && i === wumpusRoom) ? r.icon : "?";
    minimapEl.appendChild(cell);
  });
}

// ‚îÄ‚îÄ Room rendering ‚îÄ‚îÄ
function renderRoom() {
  const room = ROOMS[currentRoom];
  roomIcon.innerText = room.icon;
  roomIcon.style.transform = "scale(1.1)";
  setTimeout(() => roomIcon.style.transform = "scale(1)", 200);
  roomName.innerText = room.name;
  roomDesc.innerText = room.desc;

  roomAlert.style.display = "none";
  if (currentRoom === wumpusRoom) {
    if (tasksCompleted.length >= TASKS_REQUIRED) {
      endGame(true);
      return;
    } else {
      // Not prepared ‚Äî access denied, bounce back
      roomAlert.style.display = "";
      roomAlert.className = "room-alert locked";
      roomAlert.innerText = "üîí ACCESS DENIED ‚Äî Threat detected but you lack clearance. Complete " + (TASKS_REQUIRED - tasksCompleted.length) + " more task(s)!";
      roomDisplay.style.animation = "shake 0.4s";
      setTimeout(() => roomDisplay.style.animation = "", 400);
      sendEvent("access.onguard.badge_scan", "alert", "lenel-reader-" + room.name.toLowerCase().replace(/ /g, "-"), {
        action: "ACCESS_DENIED", eventType: 5,
        eventDescription: "Security sweep clearance requires " + TASKS_REQUIRED + " completed tasks",
        cardholderID: badge.cardholderID, badgeID: badge.badgeID,
        tasksCompleted: tasksCompleted.length, tasksRequired: TASKS_REQUIRED,
      });
      setTimeout(() => {
        const retreat = room.adj.find(a => a !== wumpusRoom) || room.adj[0];
        currentRoom = retreat;
        renderRoom();
      }, 2000);
      renderMinimap();
      renderActions(room);
      return;
    }
  }
  if (hintRooms.has(currentRoom)) {
    roomAlert.style.display = "";
    roomAlert.className = "room-alert warn";
    roomAlert.innerText = "‚ö†Ô∏è Anomalous activity detected nearby";
    sendEvent("alert.proximity", "alert", "motion-sensor-" + room.name.toLowerCase().replace(/ /g, "-"), {
      action: "anomaly_nearby", severity: "warning"
    });
  }

  // Room-specific auto sensors (generates passive events)
  triggerRoomSensors(room);

  // Render actions
  renderActions(room);
  renderMinimap();
}

function triggerRoomSensors(room) {
  // Each room fires 1-2 automatic sensor events
  setTimeout(() => {
    if (gameOver) return;
    sendEvent("sensor.environmental", "sensor", "env-" + room.name.toLowerCase().replace(/ /g, "-"), {
      metric: "temperature",
      value: (68 + Math.random() * 8).toFixed(1) + "¬∞F",
    });
  }, 800 + Math.random() * 1200);

  if (Math.random() > 0.5) {
    setTimeout(() => {
      if (gameOver) return;
      const metrics = ["humidity", "air-quality", "noise-level", "light-level"];
      const m = metrics[Math.floor(Math.random() * metrics.length)];
      const vals = { humidity: Math.round(35 + Math.random() * 30) + "%", "air-quality": Math.round(80 + Math.random() * 20) + " AQI", "noise-level": Math.round(30 + Math.random() * 40) + " dB", "light-level": Math.round(200 + Math.random() * 600) + " lux" };
      sendEvent("sensor.environmental", "sensor", "env-" + room.name.toLowerCase().replace(/ /g, "-"), {
        metric: m, value: vals[m],
      });
    }, 2000 + Math.random() * 2000);
  }
}

function renderActions(room) {
  actionsEl.innerHTML = "";

  // Movement buttons ‚Äî skip locked rooms
  room.adj.forEach(adjId => {
    if (lockedRooms.has(adjId)) return;
    const adj = ROOMS[adjId];
    const btn = document.createElement("button");
    btn.className = "action-btn";
    if (visited.has(adjId)) {
      btn.innerHTML = '<span class="icon">' + adj.icon + '</span> ' + adj.name;
    } else {
      btn.innerHTML = '<span class="icon">ü™™</span> Badge ‚Üí Door ' + (adjId + 1);
    }
    btn.onclick = () => moveToRoom(adjId);
    actionsEl.appendChild(btn);
  });

  // Room task button (if task exists and not done)
  if (room.task && !completedRoomTasks.has(currentRoom)) {
    const btn = document.createElement("button");
    btn.className = "action-btn task-btn";
    btn.innerHTML = '<span class="icon">' + room.task.icon + '</span> ' + room.task.label;
    btn.onclick = () => startTask(room);
    actionsEl.appendChild(btn);
  }

  // Inspect
  const inspect = document.createElement("button");
  inspect.className = "action-btn";
  inspect.innerHTML = '<span class="icon">üîç</span> Inspect';
  inspect.onclick = () => inspectRoom();
  actionsEl.appendChild(inspect);

  // Listen
  const listen = document.createElement("button");
  listen.className = "action-btn";
  listen.innerHTML = '<span class="icon">üëÇ</span> Listen';
  listen.onclick = () => listenRoom();
  actionsEl.appendChild(listen);
}

// ‚îÄ‚îÄ Actions ‚îÄ‚îÄ
function moveToRoom(roomId) {
  if (gameOver) return;
  const wasVisited = visited.has(roomId);
  visited.add(roomId);
  currentRoom = roomId;
  const room = ROOMS[roomId];
  const readerSlug = room.name.toLowerCase().replace(/ /g, "-");

  // ‚îÄ‚îÄ Lenel OnGuard badge scan event ‚îÄ‚îÄ
  // This mirrors the real OnGuard event structure
  const clearanceFail = (roomId === wumpusRoom && Math.random() > 0.6);
  const granted = !clearanceFail;

  sendEvent("access.onguard.badge_scan", "tap",
    "lenel-reader-" + readerSlug, {
    action: granted ? "ACCESS_GRANTED" : "ACCESS_DENIED",
    // OnGuard panel / reader
    panelID: 10 + Math.floor(roomId / 4),
    readerID: (roomId % 4) + 1,
    readerName: "RDR-" + room.name.toUpperCase().replace(/ /g, "-"),
    inputPoint: "Door-" + (roomId + 1),
    // Cardholder
    cardholderID: badge.cardholderID,
    badgeID: badge.badgeID,
    facilityCode: badge.facilityCode,
    cardFormat: badge.cardFormat,
    accessLevel: badge.accessLevel,
    cardholderName: badge.firstName + " " + badge.lastName,
    department: badge.department,
    // Event classification
    eventType: granted ? 1 : 5,
    eventClass: granted ? "GRANT" : "DENY",
    eventDescription: granted
      ? "Access granted"
      : clearanceFail ? "Access denied - clearance level insufficient" : "Access denied",
    // Timestamps
    deviceTimestamp: new Date().toISOString(),
    panelTimestamp: new Date(Date.now() - Math.floor(Math.random() * 150)).toISOString(),
    serverTimestamp: new Date(Date.now() + Math.floor(Math.random() * 50)).toISOString(),
    // Physical door state
    doorForced: false,
    doorHeldOpen: false,
    antiPassback: false,
    firstCardUnlock: !wasVisited && roomId !== 0,
    duress: false,
  });

  // ‚îÄ‚îÄ Door state change: opened ‚îÄ‚îÄ
  sendEvent("access.onguard.door_state", "status",
    "lenel-panel-" + (10 + Math.floor(roomId / 4)), {
    action: "DOOR_OPENED",
    inputPoint: "Door-" + (roomId + 1),
    readerName: "RDR-" + room.name.toUpperCase().replace(/ /g, "-"),
    doorContactState: "open",
    rexActive: false,
    lockRelayState: "unlocked",
    relockTimerSec: 5,
    doorType: room.id === 7 || room.id === 11 ? "high-security" : "standard",
  });

  // ‚îÄ‚îÄ Door re-lock after realistic delay ‚îÄ‚îÄ
  setTimeout(() => {
    if (gameOver) return;
    sendEvent("access.onguard.door_state", "status",
      "lenel-panel-" + (10 + Math.floor(roomId / 4)), {
      action: "DOOR_CLOSED",
      inputPoint: "Door-" + (roomId + 1),
      readerName: "RDR-" + room.name.toUpperCase().replace(/ /g, "-"),
      doorContactState: "closed",
      lockRelayState: "locked",
    });
  }, 2000 + Math.random() * 1500);

  renderRoom();
}

function inspectRoom() {
  if (gameOver) return;
  const room = ROOMS[currentRoom];

  sendEvent("action.inspect", "tap", "user-interaction", {
    action: "inspect",
    roomId: currentRoom,
  });

  roomAlert.style.display = "";
  if (currentRoom === wumpusRoom) {
    endGame(true);
    return;
  }

  // Count how many adjacent rooms have the wumpus
  const adjToWumpus = room.adj.filter(a => a === wumpusRoom).length > 0;
  const adjToHint = room.adj.filter(a => hintRooms.has(a)).length;

  if (adjToWumpus) {
    roomAlert.className = "room-alert danger";
    roomAlert.innerText = "üî¥ Threat detected in adjacent zone!";
    sendEvent("alert.threat_adjacent", "alert", "analysis-engine", { action: "threat_adjacent", severity: "critical" });
  } else if (adjToHint > 0) {
    roomAlert.className = "room-alert warn";
    roomAlert.innerText = "üü° Elevated readings " + adjToHint + " zone(s) away";
  } else {
    roomAlert.className = "room-alert safe";
    roomAlert.innerText = "üü¢ Zone clear ‚Äî no anomalies";
  }
}

function listenRoom() {
  if (gameOver) return;
  sendEvent("action.listen", "tap", "user-interaction", {
    action: "listen", roomId: currentRoom,
  });

  roomAlert.style.display = "";
  const dist = bfs(currentRoom, wumpusRoom);

  if (dist <= 1) {
    roomAlert.className = "room-alert danger";
    roomAlert.innerText = "üîä Heavy movement very close!";
  } else if (dist <= 2) {
    roomAlert.className = "room-alert warn";
    roomAlert.innerText = "üîä Faint sounds from " + dist + " rooms away";
  } else {
    roomAlert.className = "room-alert info";
    roomAlert.innerText = "üîá Quiet. Threat is far away.";
  }
}

function bfs(from, to) {
  const q = [[from, 0]];
  const seen = new Set([from]);
  while (q.length) {
    const [node, d] = q.shift();
    if (node === to) return d;
    for (const adj of ROOMS[node].adj) {
      if (!seen.has(adj)) { seen.add(adj); q.push([adj, d + 1]); }
    }
  }
  return 99;
}

function endGame(won) {
  gameOver = true;
  const elapsed = Math.round((Date.now() - startTime) / 1000);

  sendEvent("game.complete", "status", "game-engine", {
    result: won ? "threat_neutralized" : "game_over",
    roomsVisited: visited.size,
    totalEvents: eventCount,
    elapsedSeconds: elapsed,
  });

  gameArea.style.display = "none";
  endScreen.classList.add("active");
  endIcon.innerText = won ? "üèÜ" : "üíÄ";
  endTitle.innerText = won ? "Wumpus Confronted!" : "Game Over";
  endStats.innerHTML =
    "Rooms explored: <strong>" + visited.size + " / " + ROOMS.length + "</strong><br>" +
    "Tasks completed: <strong>" + tasksCompleted.length + "</strong><br>" +
    "Events generated: <strong>" + eventCount + "</strong><br>" +
    "Time: <strong>" + Math.floor(elapsed / 60) + ":" + String(elapsed % 60).padStart(2, "0") + "</strong><br><br>" +
    "<span style='color:var(--muted);font-size:12px'>Every badge scan, task, and sensor reading<br>flowed as a real Lenel OnGuard event through<br>SAP Edge Integration Cell on Red Hat OpenShift</span>";

  renderMinimap();
}

// ‚îÄ‚îÄ Start ‚îÄ‚îÄ
startBtn.onclick = () => {
  splash.classList.add("gone");
  startTime = Date.now();
  placeWumpus();
  captureDeviceTelemetry();

  sendEvent("session.start", "status", "game-engine", {
    action: "session_start",
    totalRooms: ROOMS.length,
    wumpusRoom: "hidden", // don't leak it
  });

  // ‚îÄ‚îÄ Lenel OnGuard: badge activation / visitor enrollment ‚îÄ‚îÄ
  sendEvent("access.onguard.badge_activate", "tap", "lenel-enrollment-station", {
    action: "BADGE_ACTIVATED",
    cardholderID: badge.cardholderID,
    badgeID: badge.badgeID,
    facilityCode: badge.facilityCode,
    cardFormat: badge.cardFormat,
    cardholderName: badge.firstName + " " + badge.lastName,
    accessLevel: badge.accessLevel,
    department: badge.department,
    activationType: "VISITOR_TEMP",
    issueDate: badge.issueDate,
    expiryDate: badge.expiryDate,
    enrollmentStation: "KIOSK-LOBBY-1",
  });

  updateTaskBar();
  renderRoom();
};
</script>
</body>
</html>
