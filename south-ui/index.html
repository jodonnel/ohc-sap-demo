<!doctype html>
<html>
<head>
  <title>South Sender</title>
  <style>
    body { font-family: system-ui, sans-serif; background: #111; color: #0f0; margin: 40px; text-align: center; }
    h2 { color: #ff0; }
    button { padding: 15px 30px; font-size: 1.2em; margin: 10px; border-radius: 8px; cursor: pointer; }
    #status { margin-top: 20px; font-size: 1.1em; color: #ff0; }
  </style>
</head>
<body>
  <h2>South Sender</h2>
  <p>Tap to send events north</p>

  <button onclick="send('tap')" style="background:#0f0;color:#000;">TAP</button>
  <button onclick="send('swipe')" style="background:#ff0;color:#000;">SWIPE</button>
  <button onclick="send('error')" style="background:#f00;color:#fff;">ERROR</button>
  <button onclick="send('status')" style="background:#00f;color:#fff;">STATUS</button>
  <button onclick="send('metric')" style="background:#0ff;color:#000;">METRIC</button>

  <p id="status">Waiting...</p>

  <!--
    NORTH_URL is injected by the deploy overlay. When served via ConfigMap,
    the kustomize patch replaces this value per-environment.
    For local development, point at your local north instance.
  -->
  <script>
  const NORTH_URL = "__NORTH_URL__";

  async function send(type) {
    const payload = {
      device: "mobile-sim",
      event: type,
      ts: new Date().toISOString(),
    };

    if (type === 'tap') {
      payload.action = 'door_open';
      payload.count = Math.floor(Math.random() * 100);
    } else if (type === 'swipe') {
      payload.action = 'card_swipe';
      payload.card_id = 'A' + Math.floor(Math.random() * 9999).toString().padStart(4, '0');
    } else if (type === 'error') {
      payload.error = 'Simulated access denied';
      payload.code = 403;
    } else if (type === 'status') {
      payload.status = 'idle';
      payload.battery = Math.floor(Math.random() * 100) + '%';
    } else if (type === 'metric') {
      payload.metric = 'temperature';
      payload.value = (Math.random() * 30 + 10).toFixed(1) + 'Â°C';
    }

    try {
      const r = await fetch(`${NORTH_URL}/ingest`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!r.ok) {
        const errText = await r.text();
        throw new Error(`HTTP ${r.status}: ${errText}`);
      }

      const j = await r.json();
      document.getElementById("status").innerText = `ACK from north. Count now: ${j.count}`;
    } catch (e) {
      document.getElementById("status").innerText = `Send failed: ${e.message}`;
      console.error("Payload attempted:", JSON.stringify(payload, null, 2));
      console.error(e);
    }
  }
  </script>
</body>
</html>
