<!DOCTYPE html>
<html>
<head>
  <title>OHC Stage â€” Live Events</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Red+Hat+Display:wght@300;400;700;900&family=Red+Hat+Mono:wght@400;700&family=Red+Hat+Text:wght@300;400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #06090F;
      --surface: #0D1117;
      --border: #1C2333;
      --muted: #4E5D6C;
      --text: #F0F4F8;
      --green: #00D26A;
      --green-glow: rgba(0, 210, 106, 0.15);
      --blue: #0070F2;
      --red: #EE0000;
      --amber: #F59E0B;
      --purple: #7C3AED;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Red Hat Display', sans-serif;
      min-height: 100vh;
      overflow: hidden;
    }

    /* â”€â”€ Ambient background pulse â”€â”€ */
    body::before {
      content: '';
      position: fixed;
      top: 50%;
      left: 50%;
      width: 600px;
      height: 600px;
      transform: translate(-50%, -60%);
      background: radial-gradient(circle, var(--green-glow) 0%, transparent 70%);
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
      z-index: 0;
    }
    body.flash::before {
      opacity: 1;
    }

    /* â”€â”€ Layout â”€â”€ */
    .shell {
      display: grid;
      grid-template-rows: auto 1fr auto;
      height: 100vh;
      padding: 32px 48px;
      position: relative;
      z-index: 1;
    }

    /* â”€â”€ Top bar â”€â”€ */
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .brand .rh {
      color: var(--red);
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
    }
    .brand .sep { color: var(--muted); font-size: 16px; }
    .brand .sap {
      color: var(--blue);
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
    }
    .brand .title {
      color: var(--muted);
      font-size: 13px;
      font-weight: 400;
      margin-left: 20px;
      padding-left: 20px;
      border-left: 1px solid var(--border);
    }

    .controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .pill {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--muted);
      font-family: 'Red Hat Mono', monospace;
      font-size: 11px;
      padding: 6px 14px;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .pill:hover { border-color: var(--muted); color: var(--text); }
    .pill.active { border-color: var(--green); color: var(--green); }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--green);
      animation: pulse 2s infinite;
    }
    .status-dot.disconnected { background: var(--red); animation: none; }

    /* â”€â”€ Hero counter â”€â”€ */
    .hero {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    .counter-label {
      font-size: 13px;
      font-weight: 400;
      color: var(--muted);
      letter-spacing: 3px;
      text-transform: uppercase;
    }

    .counter {
      font-size: clamp(8rem, 20vw, 16rem);
      font-weight: 900;
      line-height: 1;
      color: var(--text);
      font-variant-numeric: tabular-nums;
      transition: transform 0.1s;
      text-shadow: 0 0 80px var(--green-glow);
    }
    .counter.bump {
      transform: scale(1.04);
    }

    .rate {
      font-family: 'Red Hat Mono', monospace;
      font-size: 14px;
      color: var(--green);
      opacity: 0.7;
    }

    /* â”€â”€ Bottom tiles â”€â”€ */
    .tiles {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 16px;
    }

    .tile {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px 20px;
      position: relative;
      overflow: hidden;
    }
    .tile::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      border-radius: 12px 12px 0 0;
    }
    .tile.event::before { background: var(--green); }
    .tile.transport::before { background: var(--blue); }
    .tile.runtime::before { background: var(--red); }
    .tile.telemetry::before { background: var(--purple); }

    .tile h3 {
      font-size: 10px;
      font-weight: 700;
      color: var(--muted);
      letter-spacing: 1.5px;
      text-transform: uppercase;
      margin-bottom: 10px;
    }

    .tile .value {
      font-family: 'Red Hat Mono', monospace;
      font-size: 12px;
      color: var(--text);
      opacity: 0.8;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 80px;
      overflow: hidden;
    }

    .tile .meta {
      font-size: 11px;
      color: var(--muted);
      margin-top: 6px;
    }
    .tile .meta strong {
      color: var(--text);
      font-weight: 500;
    }

    /* â”€â”€ Event feed flash â”€â”€ */
    .tile.event.flash {
      border-color: var(--green);
      box-shadow: 0 0 20px var(--green-glow);
      transition: border-color 0.1s, box-shadow 0.1s;
    }

    /* â”€â”€ Animations â”€â”€ */
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.4; transform: scale(1.3); }
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .shell > * {
      animation: fadeUp 0.6s ease-out both;
    }
    .shell > *:nth-child(2) { animation-delay: 0.15s; }
    .shell > *:nth-child(3) { animation-delay: 0.3s; }
  </style>
</head>
<body>

<div class="shell">
  <!-- Top bar -->
  <div class="topbar">
    <div class="brand">
      <span class="rh">Red Hat</span>
      <span class="sep">Ã—</span>
      <span class="sap">SAP</span>
      <span class="title">Edge Integration â€” Live Stage</span>
    </div>
    <div class="controls">
      <div class="status-dot" id="statusDot"></div>
      <span class="pill" id="sseLabel">SSE connected</span>
      <span class="pill" id="muteBtn">ğŸ”Š Sound</span>
    </div>
  </div>

  <!-- Hero counter -->
  <div class="hero">
    <div class="counter-label">Events Ingested</div>
    <div class="counter" id="count">0</div>
    <div class="rate" id="rate"></div>
  </div>

  <!-- Bottom tiles -->
  <div class="tiles">
    <div class="tile event" id="eventTile">
      <h3>Last Event</h3>
      <div class="value" id="last">Waiting for eventsâ€¦</div>
      <div class="meta" id="lastTs"></div>
    </div>
    <div class="tile transport">
      <h3>Transport</h3>
      <div class="meta"><strong>Server-Sent Events</strong> (push)</div>
      <div class="meta" style="margin-top:8px">Endpoint: <strong>/events</strong></div>
      <div class="meta">Format: <strong>CloudEvents JSON</strong></div>
      <div class="meta">Keepalive: <strong>15s</strong></div>
    </div>
    <div class="tile runtime">
      <h3>Runtime</h3>
      <div class="meta">Pod: <strong id="podName">â€”</strong></div>
      <div class="meta">Platform: <strong>Red Hat OpenShift</strong></div>
      <div class="meta">Namespace: <strong>qr-demo-qa</strong></div>
      <div class="meta" style="margin-top:8px;color:var(--green)">â— Live instance</div>
    </div>
    <div class="tile telemetry">
      <h3>Audience Telemetry</h3>
      <div class="meta">Devices: <strong id="tDevices">â€”</strong></div>
      <div class="meta">Avg Battery: <strong id="tBattery">â€”</strong></div>
      <div class="meta">Networks: <strong id="tNetworks">â€”</strong></div>
      <div class="meta">Locales: <strong id="tLocales">â€”</strong></div>
    </div>
  </div>
</div>

<audio id="beep" src="/assets/Mario-coin-sound.mp3" preload="auto"></audio>

<script>
  const countEl   = document.getElementById("count");
  const lastEl    = document.getElementById("last");
  const lastTsEl  = document.getElementById("lastTs");
  const eventTile = document.getElementById("eventTile");
  const rateEl    = document.getElementById("rate");
  const beep      = document.getElementById("beep");
  const muteBtn   = document.getElementById("muteBtn");
  const statusDot = document.getElementById("statusDot");
  const sseLabel  = document.getElementById("sseLabel");

  let muted = localStorage.getItem("muted") === "true";
  let audioUnlocked = false;
  let eventTimes = [];

  function updateMuteUI() {
    muteBtn.innerText = muted ? "ğŸ”‡ Muted" : "ğŸ”Š Sound";
    muted ? muteBtn.classList.remove("active") : muteBtn.classList.add("active");
  }

  muteBtn.onclick = async () => {
    muted = !muted;
    localStorage.setItem("muted", muted);
    updateMuteUI();
    if (!audioUnlocked && !muted) {
      try {
        await beep.play();
        beep.pause();
        beep.currentTime = 0;
        audioUnlocked = true;
      } catch (e) { console.warn("audio unlock failed", e); }
    }
  };
  updateMuteUI();

  // Rate calculation
  function calcRate() {
    const now = Date.now();
    eventTimes = eventTimes.filter(t => now - t < 10000);
    if (eventTimes.length < 2) {
      rateEl.innerText = "";
      return;
    }
    const rate = (eventTimes.length / 10).toFixed(1);
    rateEl.innerText = rate + " events/sec";
  }

  // SSE connection
  let es;
  function connect() {
    es = new EventSource("/events");
    statusDot.classList.remove("disconnected");
    sseLabel.innerText = "SSE connected";

    es.onmessage = (e) => {
      const d = JSON.parse(e.data);

      // Counter bump
      countEl.innerText = d.count;
      countEl.classList.add("bump");
      setTimeout(() => countEl.classList.remove("bump"), 100);

      // Background flash
      document.body.classList.add("flash");
      setTimeout(() => document.body.classList.remove("flash"), 300);

      // Event tile flash
      eventTile.classList.add("flash");
      setTimeout(() => eventTile.classList.remove("flash"), 400);

      // Last event
      const payload = d.payload || {};
      const display = Object.keys(payload).length
        ? JSON.stringify(payload, null, 2)
        : JSON.stringify(d, null, 2);
      lastEl.innerText = display;

      // Timestamp
      if (d.ts) {
        const t = new Date(d.ts);
        lastTsEl.innerText = t.toLocaleTimeString();
      }

      // Rate tracking
      eventTimes.push(Date.now());
      calcRate();

      // Sound
      if (!muted && audioUnlocked) {
        const chime = beep.cloneNode();
        chime.volume = 0.6;
        chime.play().catch(() => {});
      }
    };

    es.onerror = () => {
      statusDot.classList.add("disconnected");
      sseLabel.innerText = "Reconnectingâ€¦";
      es.close();
      setTimeout(connect, 3000);
    };
  }
  connect();

  // Pod name
  fetch("/pod-name").then(r=>r.json()).then(d=>{document.getElementById("podName").innerText=d.pod}).catch(()=>{});

  // Rate refresh
  setInterval(calcRate, 1000);

  // Telemetry polling
  setInterval(() => {
    fetch("/telemetry").then(r=>r.json()).then(d=>{
      document.getElementById("tDevices").innerText = d.devices;
      document.getElementById("tBattery").innerText = d.avgBattery + "%";
      document.getElementById("tNetworks").innerText = Object.entries(d.networks).map(([k,v])=>k+":"+v).join(" \u00b7 ") || "\u2014";
      document.getElementById("tLocales").innerText = Object.keys(d.locales).length + " locales";
    }).catch(()=>{});
  }, 5000);
</script>

</body>
</html>
